---
networks:
  kubernetes-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.20.0/24
          gateway: 172.20.20.1

services:

  azurite:
    image: mcr.microsoft.com/azure-storage/azurite:3.29.0
    container_name: "azurite"
    hostname: azurite
    command: "azurite-blob --blobHost 0.0.0.0 --blobPort 10000"
    networks:
      kubernetes-net:
        ipv4_address: 172.20.20.14
    ports:
      - "10000:10000"
    healthcheck:
      test: nc 127.0.0.1 10000 -z
      interval: 1s
      retries: 30

  azurite-seed:
    image: rclone/rclone:1.65
    depends_on:
      azurite:
        condition: service_healthy
    volumes:
      - ./:/examples
    environment:
      - RCLONE_CONFIG_BLOBS_TYPE=azureblob
      - RCLONE_CONFIG_BLOBS_ENDPOINT=http://172.20.20.14:10000/devstoreaccount1
      - RCLONE_CONFIG_BLOBS_USE_EMULATOR=true
    entrypoint:
      - sh
      - -c
      - |
        echo "create azure container"
        rclone mkdir blobs:example
        echo "upload dummy file"
        rclone copy /example/data/ blobs:example
        touch /tmp/finished
        echo "done"
        sleep 300 # because docker-compose --exit-code-from implies --abort-on-container-exit
    healthcheck:
      test: stat /tmp/finished
      interval: 1s
      retries: 30

  local-registry:
    image: registry:2.7.1
    ports:
      - "5500:5000"
    volumes:
      - ./registry/local-registry:/var/lib/registry
    networks:
      kubernetes-net:
        ipv4_address: 172.20.20.16

  kubernetes:
    image: rancher/k3s:v1.31.5-k3s1
    command:
      - server
      - --disable=traefik
      - --resolv-conf=/kube/container-resolv.conf
    ports:
      - "6443:6443"
      - "32788:80" # Forward the traefik-ingress nodeport
      - "32789:8080" # Forward the traefik-ingress dashboard port
    privileged: true
    depends_on:
      azurite:
        condition: service_healthy
    environment:
      - K3S_TOKEN=test
      - K3S_KUBECONFIG_OUTPUT=/kube/kubeconfig.yaml
      - K3S_KUBECONFIG_MODE=666
    volumes:
      - ./kube:/kube
      - ./kube/registries.yaml:/etc/rancher/k3s/registries.yaml
    networks:
      kubernetes-net:
        ipv4_address: 172.20.20.10
    healthcheck:
      test: ["CMD-SHELL", "kubectl get pods"]
      interval: 1s
      timeout: 1s
      retries: 1000
    extra_hosts:
      - "local-registry:172.20.20.16"

  dns:
    image: chenhw2/dnsproxy:latest
    command: "/usr/bin/dnsproxy -u 127.0.0.11:53"
    networks:
      kubernetes-net:
        ipv4_address: 172.20.20.100
